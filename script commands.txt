- Load env variables into current environment

Get-Content .\infra\kafka.env | ForEach-Object {
  if ($_ -match '^\s*#' -or $_ -match '^\s*$') { return }
  $name,$value = $_ -split '=',2
  [Environment]::SetEnvironmentVariable($name.Trim(),$value.Trim(),'Process')
}

- Download kcat image

docker run --rm -it edenhill/kcat:1.7.1 -h

- Test connection to kafka cluster/Test Metadata

docker run --rm -it edenhill/kcat:1.7.1 kcat -L -b "$($env:KAFKA_BOOTSTRAP)" -X security.protocol=SASL_SSL -X sasl.mechanisms=PLAIN -X sasl.username="$($env:KAFKA_API_KEY)" -X sasl.password="$($env:KAFKA_API_SECRET)"


- Produce a test message to aerosparks.watch with avro in Python REPL

import os, datetime, json
from confluent_kafka import SerializingProducer
from confluent_kafka.schema_registry import SchemaRegistryClient, Schema
from confluent_kafka.schema_registry.avro import AvroSerializer

sr = SchemaRegistryClient({
    "url": os.environ["SCHEMA_REGISTRY_URL"],
    "basic.auth.user.info": f'{os.environ["SCHEMA_REGISTRY_KEY"]}:{os.environ["SCHEMA_REGISTRY_SECRET"]}'
})

watch_schema_str = json.dumps({
  "type": "record",
  "name": "WatchEvent",
  "namespace": "aerosparks",
  "fields": [
    {"name": "event", "type": {"type": "enum", "name": "EventTypeWatch", "symbols": ["watch"]}},
    {"name": "user_id", "type": "long"},
    {"name": "movie_id", "type": "long"},
    {"name": "timestamp", "type": "string"},
    {"name": "platform", "type": ["null", "string"], "default": None}
  ]
})

watch_schema = Schema(schema_str=watch_schema_str, schema_type="AVRO")

producer = SerializingProducer({
    "bootstrap.servers": os.environ["KAFKA_BOOTSTRAP"],
    "security.protocol": "SASL_SSL",
    "sasl.mechanisms": "PLAIN",
    "sasl.username": os.environ["KAFKA_API_KEY"],
    "sasl.password": os.environ["KAFKA_API_SECRET"],
    "value.serializer": AvroSerializer(sr, watch_schema)
})

val = {
    "event": "watch",
    "user_id": 1,
    "movie_id": 42,
    "timestamp": datetime.datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ"),
    "platform": "web"
}

producer.produce("aerosparks.watch", value=val)
producer.flush()
print("✔ Produced Avro → aerosparks.watch")



- verify aerospark.watch

docker run --rm -it confluentinc/cp-kcat:latest `
  -b "$env:KAFKA_BOOTSTRAP" `
  -X security.protocol=SASL_SSL `
  -X sasl.mechanisms=PLAIN `
  -X sasl.username="$env:KAFKA_API_KEY" `
  -X sasl.password="$env:KAFKA_API_SECRET" `
  -t aerosparks.watch -C -o -1 `
  -r "https://$($env:SCHEMA_REGISTRY_KEY):$($env:SCHEMA_REGISTRY_SECRET)@$(($env:SCHEMA_REGISTRY_URL -replace '^https://'))" `
  -s value=avro



- Testing





